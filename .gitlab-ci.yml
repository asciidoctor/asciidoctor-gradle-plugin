stages:
  - infrastructure
  - build
  - test
  - docs
#  - reports
#  - release

cache:
  key: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME-$CI_JOB_STAGE-$CI_JOB_NAME"
  paths:
    - $HOME/.gradle

#variables:
#  DOCKER_ORGANISATION: asciidoctor
#  DOCKER_PROJECT: docker-libxss-gcc-openjdk
#  DOCKER_IMAGE: libxss-openjdk-8
#
#docker:
#  stage: infrastructure
#  image: docker:latest
#  services:
#    - docker:dind
#  variables:
#    CONTAINER_TEST_IMAGE: $CI_REGISTRY/$DOCKER_ORGANISATION/$DOCKER_PROJECT/$DOCKER_IMAGE:$CI_COMMIT_REF_NAME
#    CONTAINER_RELEASE_IMAGE: $CI_REGISTRY/$DOCKER_ORGANISATION/$DOCKER_PROJECT/$DOCKER_IMAGE:latest
#  before_script:
#    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
#  script:
#    - docker build --pull -t $CONTAINER_TEST_IMAGE .
#    - docker push $CONTAINER_TEST_IMAGE
#    - docker tag $CONTAINER_TEST_IMAGE $CONTAINER_RELEASE_IMAGE
#    - docker push $CONTAINER_RELEASE_IMAGE

testrepo:
  stage: infrastructure
  image: openjdk:8
  script: ./gradlew -i --console=plain --no-build-cache :testfixtures-offline-repo:buildOfflineRepositories
  artifacts:
    paths:
      - testfixtures/offline-repo/build/repo/
    expire_in: 90min
    when: always
  except:
    - pages
    - gh-pages
    - tags
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME-$CI_JOB_STAGE-$CI_JOB_NAME"
    paths:
      - $HOME/.gradle
      - testfixtures/offline-repo/build/repo/

jdk8:
  stage: build
  image: openjdk:8
  script: ./gradlew -i -S --console=plain --no-build-cache assemble codenarcAll license
  artifacts:
    paths:
      - .gradle/
      - '*/build/'
    expire_in: 60min
    when: always
  except:
    - pages
    - gh-pages
    - tags

jdk11:
  stage: build
  image: openjdk:11
  script: ./gradlew -i -S --console=plain --no-build-cache assemble
  artifacts:
    paths:
      - .gradle/
      - '*/build/'
    expire_in: 60min
    when: always
  except:
    - pages
    - gh-pages
    - tags

jdk12:
  stage: build
  image: openjdk:12
  script: ./gradlew -i -S --console=plain --no-build-cache assemble
  artifacts:
    paths:
      - .gradle/
      - '*/build/'
    expire_in: 60min
    when: always
  except:
    - pages
    - gh-pages
    - tags

# $CI_REGISTRY/ysb33rorg/docker-gcc-openjdk/gcc-openjdk-8:latest
test:integration:
  stage: test
  image: openjdk:8
  except:
    - pages
    - gh-pages
    - tags
  dependencies:
    - testrepo
    - jdk8
  script: ./gradlew -i -s --console=plain --no-build-cache test intTest remoteTest -x :asciidoctor-gradle-slides-export:intTest
  artifacts:
    paths:
      - '*/build/reports'
      - '*/build/jacoco'
    expire_in: 10 days
    when: on_failure

test:gradle_4.0.2,4.1,4.2.1:
  stage: test
  image: openjdk:8
  except:
    - pages
    - gh-pages
    - tags
  dependencies:
    - testrepo
    - jdk8
  script: ./run-compatibility-test-on-ci.sh
  artifacts:
    paths:
      - '*/build/reports'
      - '*/build/jacoco'
    expire_in: 10 days
    when: on_failure

test:gradle_4.3.1,4.4.1,4.5.1:
  stage: test
  image: openjdk:8
  except:
    - pages
    - gh-pages
    - tags
  dependencies:
    - testrepo
    - jdk8
  script: ./run-compatibility-test-on-ci.sh
  artifacts:
    paths:
      - '*/build/reports'
      - '*/build/jacoco'
    expire_in: 10 days
    when: on_failure

test:gradle_4.6,4.7,4.8.1:
  stage: test
  image: openjdk:8
  except:
    - pages
    - gh-pages
    - tags
  dependencies:
    - testrepo
    - jdk8
  script: ./run-compatibility-test-on-ci.sh
  artifacts:
    paths:
      - '*/build/reports'
      - '*/build/jacoco'
    expire_in: 10 days
    when: on_failure

test:gradle_4.9,4.10.2:
  stage: test
  image: openjdk:11
  except:
    - pages
    - gh-pages
    - tags
  dependencies:
    - testrepo
    - jdk11
  script: ./run-compatibility-test-on-ci.sh
  artifacts:
    paths:
      - '*/build/reports'
      - '*/build/jacoco'
    expire_in: 10 days
    when: on_failure

test:gradle_5.0,5.1.1,5.3.1:
  stage: test
  image: openjdk:11
  except:
    - pages
    - gh-pages
    - tags
  dependencies:
    - testrepo
    - jdk11
  script: ./run-compatibility-test-on-ci.sh
  artifacts:
    paths:
      - '*/build/reports'
      - '*/build/jacoco'
    expire_in: 10 days
    when: on_failure

test:gradle_5.4:
  stage: test
  image: openjdk:12
  except:
    - pages
    - gh-pages
    - tags
  dependencies:
    - testrepo
    - jdk11
  script: ./run-compatibility-test-on-ci.sh
  artifacts:
    paths:
      - '*/build/reports'
      - '*/build/jacoco'
    expire_in: 10 days
    when: on_failure

htmldocs:
  stage: docs
  image: openjdk:11
  dependencies:
    - testrepo
    - jdk11
  script: ./gradlew groovydoc && cd docs && ./gradlew --console=plain asciidoctor
  artifacts:
    paths:
      - '*/build/docs/combined'

#jacoco:
#  stage: reports
#  image: openjdk:11
#  dependencies:
#    - test:integration
#    - test:gradle_5.0,5.1.1
#  except:
#    - pages
#    - gh-pages
#    - tags
#  script: ./gradlew --console=plain jacocoRootReport coveralls

#publish:
#  stage: release
#  image: openjdk:8
#  script: ./gradlew -s -i --console=plain --no-build-cache installDocs publishPlugins gitPublishPush -i -Dgradle.publish.key=$GRADLE_PORTAL_KEY -Dgradle.publish.secret=$GRADLE_PORTAL_SECRET -Dorg.ajoberstar.grgit.auth.username=$PAGES_PUBLISH_USER -Dorg.ajoberstar.grgit.auth.password=$PAGES_PUBLISH_KEY -Dorg.ajoberstar.grgit.auth.force=hardcoded
#  dependencies:
#  - jdk8
#  only:
#  - release
#
#pages:
#  stage: release
#  script: ls -la
#  artifacts:
#    paths:
#    - public
#  only:
#  - pages

